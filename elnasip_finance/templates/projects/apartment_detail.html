{% extends 'base.html' %}
{% load humanize %}
{% block page_title %}–ö–≤–∞—Ä—Ç–∏—Ä–∞ {{ apartment.apartment_number }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–ö–≤–∞—Ä—Ç–∏—Ä–∞ {{ apartment.apartment_number }} ({{ apartment.block }})</h2>
    <div class="d-flex gap-2">
        <a href="{% url 'projects:apartment_list' apartment.block.id %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <a href="{% url 'projects:sell_apartment' apartment.id %}" class="btn btn-secondary">–ü—Ä–æ–¥–∞—Ç—å</a>
        <a href="{% url 'projects:rent_apartment' apartment.id %}" class="btn btn-info">–ê—Ä–µ–Ω–¥–∞</a>
        <a href="{% url 'projects:add_payment' apartment.id %}" class="btn btn-primary">+ –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ–¥–∞–∂–∏</a>
        <a href="{% url 'projects:add_rent_payment' apartment.id %}" class="btn btn-success">+ –ê—Ä–µ–Ω–¥–Ω—ã–π –ø–ª–∞—Ç–µ–∂</a>
        <a href="{% url 'projects:reserve_apartment' apartment.id %}" class="btn btn-warning">–ë—Ä–æ–Ω—å</a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <!-- –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —à–∞–±–ª–æ–Ω–∞) -->
                    <tr>
                        <th>–ë–ª–æ–∫:</th>
                        <td>{{ apartment.block }}</td>
                    </tr>
                    <tr>
                        <th>–≠—Ç–∞–∂:</th>
                        <td>{{ apartment.floor|intcomma }}</td>
                    </tr>
                    <tr>
                        <th>–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã:</th>
                        <td>{{ apartment.apartment_number }}</td>
                    </tr>
                    <tr>
                        <th>–ö–æ–º–Ω–∞—Ç:</th>
                        <td>{{ apartment.rooms }}</td>
                    </tr>
                    <tr>
                        <th>–ü–ª–æ—â–∞–¥—å:</th>
                        <td>{{ apartment.area|intcomma }} –º¬≤</td>
                    </tr>
                    <tr>
                        <th>–ü—Ä–æ–¥–∞–Ω–Ω–∞—è –ø–ª–æ—â–∞–¥—å:</th>
                        <td>{{ apartment.sold_area|intcomma }} –º¬≤</td>
                    </tr>
                    <tr>
                        <th>–¶–µ–Ω–∞ –∑–∞ –º¬≤ (—Ñ–∞–∫—Ç):</th>
                        <td>{{ apartment.fact_price_per_m2|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤:</th>
                        <td>{{ apartment.planned_price_per_m2|default:"-"|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Å–¥–µ–ª–∫–∞:</th>
                        <td>{{ apartment.planned_deal_amount|default:"-"|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–§–∞–∫—Ç —Å–¥–µ–ª–∫–∏:</th>
                        <td>{{ apartment.deal_Fakt_deal_amount|default:"-"|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏:</th>
                        <td>{{ apartment.deal_amount|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–û—Å—Ç–∞—Ç–æ–∫ —Å–¥–µ–ª–∫–∏:</th>
                        <td>{{ apartment.remaining_deal_amount|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–°–∫–∏–¥–∫–∞:</th>
                        <td>{{ apartment.discount|default:"-"|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–°—Ç–∞—Ç—É—Å (–ø—Ä–æ–¥–∞–∂–∞/–±—Ä–æ–Ω—å):</th>
                        <td>
                            {% if apartment.is_sold %}
                                <span class="badge bg-success">–ü—Ä–æ–¥–∞–Ω–æ</span>
                            {% elif apartment.is_reserved %}
                                <span class="badge bg-warning">–ë—Ä–æ–Ω—å</span>
                            {% else %}
                                <span class="badge bg-secondary">–°–≤–æ–±–æ–¥–Ω–æ</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>–ö–ª–∏–µ–Ω—Ç:</th>
                        <td>{{ apartment.client_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>–ù–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏:</th>
                        <td>{{ apartment.deal_number|default:"-"|intcomma }}</td>
                    </tr>

                    <!-- –ë–ª–æ–∫ –∞—Ä–µ–Ω–¥—ã (–Ω–æ–≤–æ–µ) -->
                    <tr>
                        <th>–°—Ç–∞—Ç—É—Å –∞—Ä–µ–Ω–¥—ã:</th>
                        <td>
                            {% if apartment.is_rented %}
                                {% if apartment.rent_status == 'active' %}
                                    <span class="badge bg-success">–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω–∞</span>
                                {% elif apartment.rent_status == 'expired' %}
                                    <span class="badge bg-warning">–ê—Ä–µ–Ω–¥–∞ –∏—Å—Ç–µ–∫–ª–∞</span>
                                {% else %}
                                    <span class="badge bg-info">–ê—Ä–µ–Ω–¥–∞</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">–ù–µ —Å–¥–∞–Ω–∞</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if apartment.is_rented %}
                    <tr>
                        <th>–¶–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã –≤ –º–µ—Å—è—Ü:</th>
                        <td>{{ apartment.rent_price_per_month|intcomma }} —Å–æ–º</td>
                    </tr>
                    <tr>
                        <th>–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã:</th>
                        <td>
                            {{ apartment.rent_start_date|date:"d.m.Y" }} ‚Äì
                            {{ apartment.rent_end_date|date:"d.m.Y" }}
                        </td>
                    </tr>
                    <tr>
                        <th>–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä:</th>
                        <td>{{ apartment.tenant_name }}</td>
                    </tr>
                    <tr>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞:</th>
                        <td>{{ apartment.tenant_phone|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>–î–æ–≥–æ–≤–æ—Ä –∞—Ä–µ–Ω–¥—ã:</th>
                        <td>{{ apartment.tenant_contract|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>–û–±—â–∏–π –¥–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã:</th>
                        <td>{{ apartment.total_rent_income|intcomma }} —Å–æ–º</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <!-- –ü–ª–∞—Ç–µ–∂–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–µ -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>–ü–ª–∞—Ç–µ–∂–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–µ</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            {% if user.is_superuser %}
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for payment in payments %}
                            <tr>
                                <td>{{ payment.payment_date|date:"d.m.Y H:i" }}</td>
                                <td>{{ payment.amount|intcomma }} —Å–æ–º</td>
                                <td>
                                    {{ payment.comment|default:"-" }}
                                    {% if payment.updated_by %}
                                        <br>
                                        <small class="text-muted">
                                            –ò–∑–º–µ–Ω–µ–Ω–æ: {{ payment.updated_at|date:"d.m.Y H:i" }}
                                            {% if payment.updated_by != payment.created_by %}
                                                ({{ payment.updated_by.username }})
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                </td>
                                {% if user.is_superuser %}
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% comment %} <a href="{% url 'projects:edit_payment' payment.id %}" class="btn btn-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a> {% endcomment %}
                                            <a href="{% url 'projects:delete_payment' payment.id %}" class="btn btn-danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{% if user.is_superuser %}4{% else %}3{% endif %}" class="text-center text-muted">
                                    –ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                        <tr class="table-primary">
                            <th>–ò—Ç–æ–≥–æ:</th>
                            <th>{{ total_paid|intcomma }} —Å–æ–º</th>
                            <td></td>
                            {% if user.is_superuser %}<td></td>{% endif %}
                        </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ) -->
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted">–í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π</small>
                                    <h6 class="mb-0">{{ payments.count }}</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted">–û–±—â–∞—è —Å—É–º–º–∞</small>
                                    <h6 class="mb-0">{{ total_paid|intcomma }} —Å–æ–º</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫</small>
                                    <h6 class="mb-0">{{ apartment.remaining_deal_amount|intcomma }} —Å–æ–º</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê—Ä–µ–Ω–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–Ω–æ–≤–æ–µ) -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>–ê—Ä–µ–Ω–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</h5>
                <a href="{% url 'projects:add_rent_payment' apartment.id %}" class="btn btn-success btn-sm">+ –î–æ–±–∞–≤–∏—Ç—å</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ü–µ—Ä–∏–æ–¥</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            {% if user.is_superuser %}
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for payment in apartment.rent_payments.all %}
                            <tr>
                                <td>{{ payment.payment_date|date:"d.m.Y H:i" }}</td>
                                <td>{{ payment.amount|intcomma }} —Å–æ–º</td>
                                <td>{{ payment.period_start|date:"d.m.Y" }} ‚Äì {{ payment.period_end|date:"d.m.Y" }}</td>
                                <td>
                                    {{ payment.comment|default:"-" }}
                                    {% if payment.updated_by %}
                                        <br>
                                        <small class="text-muted">
                                            –ò–∑–º–µ–Ω–µ–Ω–æ: {{ payment.updated_at|date:"d.m.Y H:i" }}
                                            {% if payment.updated_by != payment.created_by %}
                                                ({{ payment.updated_by.username }})
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                </td>
                                {% if user.is_superuser %}
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% comment %} <a href="{% url 'projects:edit_rent_payment' payment.id %}" class="btn btn-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a> {% endcomment %}
                                            <a href="{% url 'projects:delete_rent_payment' payment.id %}" class="btn btn-danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{% if user.is_superuser %}5{% else %}4{% endif %}" class="text-center text-muted">
                                    –ê—Ä–µ–Ω–¥–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                        <tr class="table-primary">
                            <th>–ò—Ç–æ–≥–æ:</th>
                            <th>{{ apartment.total_rent_income|intcomma }} —Å–æ–º</th>
                            <td></td>
                            <td></td>
                            {% if user.is_superuser %}<td></td>{% endif %}
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
<div class="container mt-4">
    <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
    {% if comments %}
        <ul class="list-group mb-4">
            {% for comment in comments %}
                <li class="list-group-item">
                    <p>{{ comment.text|linebreaks }}</p>
                    <small class="text-muted">
                        {{ comment.author|default:"–ê–Ω–æ–Ω–∏–º" }},
                        {{ comment.created_at|date:"d.m.Y H:i" }}
                    </small>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endif %}

    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
    <form method="post" class="mb-4">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
</div>
{% endblock %}
