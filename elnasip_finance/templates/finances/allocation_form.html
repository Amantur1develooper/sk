{% extends 'base.html' %}
{% load humanize %}
{% block page_title %}–í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑ –û–±—â–∞–≥–∞{% endblock %}

{% block content %}
<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h4>–í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑ –û–±—â–∞–≥–∞</h4>
      </div>

      <div class="card-body">
        <div class="alert alert-info">
          –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –û–±—â–∞–≥–∞: <strong>{{ common_cash.balance }} —Å–æ–º</strong>
        </div>

        <!-- üîπ –§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–∫—É -->
        <div class="mb-3">
          <label for="block" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–∫—É</label>
          <select name="block" id="block" class="form-select">
            <option value="">–í—Å–µ –±–ª–æ–∫–∏</option>
            {% for block in blocks %}
              <option value="{{ block.id }}" {% if block_id == block.id %}selected{% endif %}>
                {{ block.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- üîπ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <form method="post">
          {% csrf_token %}

          <div class="mb-3">
            <label for="{{ form.estimate_item.id_for_label }}" class="form-label">
              {{ form.estimate_item.label }}
            </label>
            {{ form.estimate_item }}
          </div>

          <div class="mb-3">
            <label for="{{ form.amount.id_for_label }}" class="form-label">
              {{ form.amount.label }}
            </label>
            {{ form.amount }}
          </div>

          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">
              {{ form.description.label }}
            </label>
            {{ form.description }}
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">–í—ã–¥–µ–ª–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
            <a href="{% url 'finances:allocations_list' %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- üîπ JS -->
<script>
  $(document).ready(function () {
    // select2 –¥–ª—è –ø–æ–ª—è estimate_item
    $('#id_estimate_item').select2({
      width: '100%',
      placeholder: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é —Å–º–µ—Ç—ã...",
      allowClear: true
    });

    // –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π —Å–º–µ—Ç—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –±–ª–æ–∫–∞
    $('#block').change(function () {
      let blockId = $(this).val();

      $.ajax({
        url: "{% url 'finances:get_estimate_items' %}",
        data: { block_id: blockId },
        success: function (data) {
          let $estimate = $('#id_estimate_item');
          $estimate.empty();
          $estimate.append('<option value="">---------</option>');
          data.forEach(function (item) {
            $estimate.append(`<option value="${item.id}">${item.name}</option>`);
          });
          $estimate.trigger('change'); // –æ–±–Ω–æ–≤–ª—è–µ–º select2
        }
      });
    });
  });
</script>
{% endblock %}
