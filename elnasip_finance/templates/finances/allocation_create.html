{% extends 'base.html' %}
{% load humanize %}
{% block page_title %}–í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑ –û–±—â–∞–≥–∞{% endblock %}

{% block content %}
{# 1) jQuery –î–û–õ–ñ–ï–ù –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω –ü–ï–†–í–´–ú #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{# 2) Select2 CSS –∏ JS #}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
      rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h4>–í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–∑ –û–±—â–∞–≥–∞</h4>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –û–±—â–∞–≥–∞:
          <strong>{{ common_cash.balance }} —Å–æ–º</strong>
        </div>

        {# üîπ —Ñ–∏–ª—å—Ç—Ä –ø–æ –±–ª–æ–∫—É #}
        <form method="get" class="mb-3">
          <label for="block" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫</label>
          <select name="block" id="block" class="form-select" onchange="this.form.submit()">
            <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ --</option>
            {% for block in blocks %}
              <option value="{{ block.id }}" {% if block_id == block.id %}selected{% endif %}>
                {{ block.name }}
              </option>
            {% endfor %}
          </select>
        </form>

        {# üîπ —Ñ–æ—Ä–º–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –±–ª–æ–∫ #}
        {% if form %}
          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label for="{{ form.estimate_item.id_for_label }}" class="form-label">
                {{ form.estimate_item.label }}
              </label>
              {# –ø–æ–ª–µ "–ü–æ–∑–∏—Ü–∏—è —Å–º–µ—Ç—ã" ‚Äî –æ–±—ã—á–Ω—ã–π select #}
              {{ form.estimate_item }}
            </div>

            <div class="mb-3">
              <label for="{{ form.amount.id_for_label }}" class="form-label">
                {{ form.amount.label }}
              </label>
              {{ form.amount }}
            </div>

            <div class="mb-3">
              <label for="{{ form.description.id_for_label }}" class="form-label">
                {{ form.description.label }}
              </label>
              {{ form.description }}
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">–í—ã–¥–µ–ª–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
              <a href="{% url 'finances:allocations_list' %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  $(function () {
    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ select –ø–æ id (—Å—Ç–∞–Ω–¥–∞—Ä—Ç Django: id="id_estimate_item")
    var $estimateField = $('#id_estimate_item');

    // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ id –¥—Ä—É–≥–æ–π ‚Äî –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –ø–æ name
    if (!$estimateField.length) {
      $estimateField = $('select[name="estimate_item"]');
    }

    console.log('–ù–∞—à–ª–∏ –ø–æ–ª–µ estimate_item? length =', $estimateField.length);
    console.log('–ï—Å—Ç—å –ª–∏ $.fn.select2?', !!$.fn.select2);

    if ($estimateField.length && $.fn.select2) {
      $estimateField.select2({
        width: '100%',
        placeholder: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é —Å–º–µ—Ç—ã...",
        allowClear: true,
        minimumResultsForSearch: 0 // –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞
      });
    }
  });
</script>
{% endblock %}
